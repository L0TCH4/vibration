<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PeerJS Shared Vibration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding-top: 40px;
  }
  button {
    font-size: 1.2em;
    padding: 20px 30px;
    margin: 10px;
  }
</style>
</head>
<body>

<h1>共有サーバー状態（PeerJS）</h1>

<p id="role"></p>

<button id="enable">振動を有効化</button><br>
<button id="hold">押し続ける</button>

<p id="state">serverState: false</p>

<script>
const HOST_ID = "shared-vibration-host";

let vibrationEnabled = false;
let vibrating = false;
let serverState = false;

const isHost = location.hash === "#host";
document.getElementById("role").textContent =
  isHost ? "あなたはホストです" : "あなたはクライアントです";

const peer = new Peer(isHost ? HOST_ID : undefined);

let connections = [];
let connToHost = null;

/* 振動許可 */
document.getElementById("enable").onclick = () => {
  vibrationEnabled = true;
  navigator.vibrate(50);
  alert("振動が有効になりました");
};

/* ホスト処理 */
if (isHost) {
  peer.on("connection", conn => {
    connections.push(conn);
    conn.on("open", () => {
      conn.send(serverState);
    });
  });
}

/* クライアント処理 */
if (!isHost) {
  peer.on("open", () => {
    connToHost = peer.connect(HOST_ID);
    connToHost.on("data", updateState);
  });
}

/* 押し続けボタン */
const holdBtn = document.getElementById("hold");

holdBtn.addEventListener("pointerdown", () => {
  if (isHost) setState(true);
});

holdBtn.addEventListener("pointerup", () => {
  if (isHost) setState(false);
});

holdBtn.addEventListener("pointerleave", () => {
  if (isHost) setState(false);
});

/* 状態更新（ホスト） */
function setState(value) {
  serverState = value;
  broadcast(value);
  updateState(value);
}

function broadcast(value) {
  connections.forEach(c => c.open && c.send(value));
}

/* 状態反映（全端末） */
function updateState(value) {
  serverState = value;
  document.getElementById("state").textContent =
    "serverState: " + value;

  if (value && vibrationEnabled && !vibrating) {
    vibrating = true;
    vibrateLoop();
  }

  if (!value) {
    vibrating = false;
    navigator.vibrate(0);
  }
}

function vibrateLoop() {
  if (!vibrating) return;
  navigator.vibrate([300]);
  setTimeout(vibrateLoop, 300);
}
</script>

</body>
</html>
