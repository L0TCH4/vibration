<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PeerJS 連続振動サーバー</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding-top: 40px;
  }
  button {
    font-size: 1.2em;
    padding: 20px 30px;
    margin: 10px;
    touch-action: none;
  }
</style>
</head>
<body>

<h1>共有サーバー状態（PeerJS）</h1>

<p id="role"></p>

<button id="enable">振動を有効化</button><br>
<button id="hold">押し続ける</button>

<p id="state">serverState: false</p>

<script>
/* =====================
   基本設定
===================== */
const HOST_ID = "shared-vibration-host";
const isHost = location.hash === "#host";

let serverState = false;
let vibrationEnabled = false;
let vibrationTimer = null;

document.getElementById("role").textContent =
  isHost ? "あなたはホストです" : "あなたはクライアントです";

/* =====================
   PeerJS 初期化
===================== */
const peer = new Peer(isHost ? HOST_ID : undefined);
let connections = [];
let connToHost = null;

/* =====================
   振動有効化
===================== */
document.getElementById("enable").onclick = () => {
  vibrationEnabled = true;
  navigator.vibrate(50);
  alert("振動が有効になりました");
};

/* =====================
   ホスト処理
===================== */
if (isHost) {
  peer.on("connection", conn => {
    connections.push(conn);

    conn.on("open", () => {
      conn.send({ type: "state", value: serverState });
    });

    conn.on("data", msg => {
      if (msg.type === "set") {
        setState(msg.value);
      }
    });
  });
}

/* =====================
   クライアント処理
===================== */
if (!isHost) {
  peer.on("open", () => {
    connToHost = peer.connect(HOST_ID);

    connToHost.on("data", msg => {
      if (msg.type === "state") {
        updateState(msg.value);
      }
    });
  });
}

/* =====================
   押し続けボタン
===================== */
const holdBtn = document.getElementById("hold");

holdBtn.addEventListener("pointerdown", () => {
  sendPress(true);
});

holdBtn.addEventListener("pointerup", () => {
  sendPress(false);
});

holdBtn.addEventListener("pointerleave", () => {
  sendPress(false);
});

function sendPress(value) {
  if (isHost) {
    setState(value);
  } else if (connToHost && connToHost.open) {
    connToHost.send({ type: "set", value });
  }
}

/* =====================
   状態管理（ホスト）
===================== */
function setState(value) {
  serverState = value;
  broadcast(value);
  updateState(value);
}

function broadcast(value) {
  connections.forEach(c => {
    if (c.open) {
      c.send({ type: "state", value });
    }
  });
}

/* =====================
   状態反映（全端末）
===================== */
function updateState(value) {
  serverState = value;
  document.getElementById("state").textContent =
    "serverState: " + value;

  if (value && vibrationEnabled) {
    startVibration();
  } else {
    stopVibration();
  }
}

/* =====================
   連続振動制御
===================== */
function startVibration() {
  if (vibrationTimer) return;
  vibrationTimer = setInterval(() => {
    navigator.vibrate(10000);
  }, 10000);
}

function stopVibration() {
  if (!vibrationTimer) return;
  clearInterval(vibrationTimer);
  vibrationTimer = null;
  navigator.vibrate(0);
}
</script>

</body>
</html>
